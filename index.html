<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>體驗頁</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --fg:#e8eef9; --muted:#a9b7d1; --accent:#6aa1ff;
      --radius:20px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;background:radial-gradient(60% 60% at 50% 40%, #0f172a, #0b1220);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;padding:24px}
    .card{width:min(880px,94vw);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px 28px 22px;border:1px solid rgba(255,255,255,.06)}
    h1{margin:0 0 8px;font-size:clamp(22px,3.5vw,32px);font-weight:700;letter-spacing:.3px}
    p{margin:0;color:var(--muted);line-height:1.6}
    .stack{display:grid;gap:14px;margin-top:10px}
    .btns{display:flex;gap:12px;margin-top:20px}
    button{appearance:none;border:0;border-radius:14px;padding:.9em 1.2em;font-size:16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#0b1220}
    .btn-secondary{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.18)}
    .hint{margin-top:10px;font-size:12px;color:#9fb3d8}
    .tag{display:inline-block;font-size:12px;padding:.2em .6em;border:1px solid rgba(255,255,255,.15);border-radius:999px;color:#9fb3d8}
    .hidden{display:none}
    .lang{opacity:.92}
    .footer{margin-top:20px;display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <main class="card" id="view-experience" aria-live="polite">
    <h1>體驗結束，請前往下一個體驗。</h1>
    <div class="stack lang">
      <p>English：This session has ended. Please proceed to the next experience.</p>
      <p>粵語：體驗結束，請前往下一個體驗。</p>
      <p>한국어：체험이 종료되었습니다. 다음 체험으로 이동해 주세요.</p>
      <p>Tiếng Việt：Trải nghiệm đã kết thúc, vui lòng chuyển sang trải nghiệm tiếp theo.</p>
    </div>
    <div class="btns">
      <button class="btn-primary" id="closeBtn">關閉</button>
    </div>
    <div class="footer"><span class="tag" id="statusTag" aria-live="polite"></span></div>
    <p class="hint">* 本頁面會以您的 IP 為單位計數「關閉」按鈕點擊次數。當同一個 IP 第四次點擊後，將自動前往完成頁。</p>
  </main>

  <section class="card hidden" id="view-done" aria-live="polite">
    <h1>你已完成體驗</h1>
    <div class="stack lang">
      <p>English：You have completed the experience.</p>
      <p>粵語：你已完成體驗。</p>
      <p>한국어：체험을 완료하셨습니다.</p>
      <p>Tiếng Việt：Bạn đã hoàn tất trải nghiệm.</p>
    </div>
    <div class="btns">
      <button class="btn-primary" id="restartBtn">重新開始</button>
      <button class="btn-secondary" id="backBtn">返回上一頁</button>
    </div>
    <div class="footer"><span class="tag" id="ipTag" aria-live="polite"></span></div>
    <p class="hint">*「重新開始」會清除此 IP 的計數。</p>
  </section>

  <script>
    // ====== 基本設定 ======
    const IP_API = 'https://api.ipify.org?format=json'; // 以第三方服務取得公開 IP（僅示範用）
    const LS_PREFIX = 'ipClicks:';
    const LAST_IP_KEY = 'lastIP';

    const $exp = document.getElementById('view-experience');
    const $done = document.getElementById('view-done');
    const $statusTag = document.getElementById('statusTag');
    const $ipTag = document.getElementById('ipTag');
    const $close = document.getElementById('closeBtn');
    const $restart = document.getElementById('restartBtn');
    const $back = document.getElementById('backBtn');

    // 以 hash 做為兩頁切換：#done 代表完成頁
    function route(){
      const isDone = location.hash.replace('#','') === 'done';
      $exp.classList.toggle('hidden', isDone);
      $done.classList.toggle('hidden', !isDone);
    }
    window.addEventListener('hashchange', route);
    route();

    // 取得 IP（若失敗，使用裝置本地 fallback key）
    async function getIP(){
      try{
        const r = await fetch(IP_API, {cache:'no-store'});
        const j = await r.json();
        if(j && j.ip){
          localStorage.setItem(LAST_IP_KEY, j.ip);
          return j.ip;
        }
      }catch(e){/* ignore */}
      // Fallback：若無法取得 IP，使用匿名裝置 key（僅本機有效）
      let devKey = localStorage.getItem(LAST_IP_KEY);
      if(!devKey){
        devKey = 'device-' + Math.random().toString(36).slice(2,10);
        localStorage.setItem(LAST_IP_KEY, devKey);
      }
      return devKey;
    }

    function getCountKey(ip){ return LS_PREFIX + ip; }

    function getCount(ip){
      const v = localStorage.getItem(getCountKey(ip));
      return v ? parseInt(v,10) || 0 : 0;
    }

    function setCount(ip, n){
      localStorage.setItem(getCountKey(ip), String(n));
    }

    function clearCount(ip){
      localStorage.removeItem(getCountKey(ip));
    }

    function showTag(msg){
      $statusTag.textContent = msg || '';
    }

    // ====== 主要互動：關閉 -> 計數 -> 第四次導向完成頁 ======
    $close.addEventListener('click', async () => {
      const ip = await getIP();
      const current = getCount(ip) + 1;
      setCount(ip, current);
      showTag(`此 IP（${ip}）已點擊 ${current} 次`);
      if(current >= 4){
        // 進入完成頁
        $ipTag.textContent = `IP：${ip}`;
        location.hash = '#done';
      }
    });

    // ====== 完成頁：重新開始（清空此 IP 計數） ======
    $restart.addEventListener('click', async () => {
      const ip = await getIP();
      clearCount(ip);
      $ipTag.textContent = `已重置：IP ${ip}`;
      // 回到體驗頁
      location.hash = '';
      showTag('已重置計數，請再次開始。');
    });

    // 可選：返回上一頁（不清空）
    $back.addEventListener('click', () => {
      history.back();
    });

    // 初始：若一開始就位於完成頁，顯示 IP 供提示
    (async () => {
      const ip = await getIP();
      $ipTag.textContent = ip ? `IP：${ip}` : '';
    })();
  </script>
</body>
</html>
